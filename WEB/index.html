<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>NYC Idling Atlas: The Regulatory Problem</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" /> 
</head>

<body>
    <!-- Extreme Left Trivariate Heatmap -->
    <div id="trivariate-heatmap-left" style="position: fixed; top: 0; left: 0; width: 400px; height: 100vh; background: rgba(0, 0, 0, 0.9); z-index: 1000; overflow: auto; padding: 1rem; display: none;"></div>
    
    <div id="story-container"> 
        <div id="map"></div> 
        <div id="features">
            <section class="step" id="step-0" data-step="0">
                <div class="narrative">
                    <h1>NYC Idling Atlas: The Regulatory Problem</h1>
                    <p>Welcome to the first chapter. Scroll down to explore the nexus of freight traffic, idling hotspots, and environmental justice across New York City.</p>
                </div>
            </section>

            <section class="step" id="step-1" data-step="1">
                <div class="narrative">
                    <h2>Chapter 1: HUMAN CITY</h2>
                    <p><strong>Problem:</strong> Establishes the city-wide extent of air quality risk and exposure.</p>
                    <p><strong>Description:</strong> This is an initial composite view showing all problem layers overlaid: major <strong>Freight Routes</strong> , <strong>Junction Hotspots</strong>, high <strong>Asthma Index Rates</strong>, and <strong>Vulnerable Facilities</strong>.</p>
                </div>
            </section>

            <section class="step" id="step-2" data-step="2">
                <div class="narrative">
                    <h2>Focus: South Bronx Density</h2>
                    <p><strong>Problem:</strong> Reveals acute exposure where <strong>Vulnerable Facilities</strong> (schools, hospitals) are directly adjacent to high-traffic and high-density idling areas.</p>
                    <p><strong>Description:</strong> Zooms in on the South Bronx to highlight the clear, high density of idling and the acute spatial relationship between traffic and sensitive sites.</p>
                </div>
                <div class="legend" id="legend-3">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: radial-gradient(circle, #FF0000, #8B0000, #4B0000); border-radius: 50%; width: 20px; height: 20px;"></div>
                        <div class="legend-label">Traffic Hotspots</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: radial-gradient(circle, #4B0000, #4B0000, #1a0033, #2980b9); border-radius: 50%; width: 20px; height: 20px;"></div>
                        <div class="legend-label">Junction Hotspots</div>
                    </div>
                </div>
            </section>

            <section class="step" id="step-3" data-step="3">
                <div class="narrative">
                    <h2>Health Burden: Vulnerable Communities</h2>
                    <p><strong>Problem:</strong> The overlap between pollution hotspots and <strong>Vulnerable Facilities</strong> (schools, healthcare centers) reveals environmental injustice, as those most sensitive to air impacts are in the areas of highest exposure.</p>
                    <p><strong>Description:</strong> Shifts focus to the <strong>Vulnerable Facilities</strong> surrounded by pollution, making a direct argument about spatial injustice.</p>
                </div>
                <div class="legend" id="legend-4">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 40px; height: 3px; margin-top: 8px; opacity: 0.8;"></div>
                        <div class="legend-label">Freight Routes</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 20px; height: 20px; opacity: 0.8;"></div>
                        <div class="legend-label">Freight Zones</div>
                        <div class="legend-color" style="background: radial-gradient(circle, #e10600, #ff0000, #a50f15); border-radius: 50%; width: 20px; height: 20px; opacity: 0.8;"></div>
                        <div class="legend-label">Traffic Hotspots</div>
                    </div>
                    <div style="margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #ccc; font-size: 0.9em;">Vulnerable Facilities</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffffff; width: 16px; height: 16px; opacity: 1.0; border-radius: 50%; border: 1px solid #ccc;"></div>
                        <div class="legend-label"> Hospitals</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #adadad; width: 16px; height: 16px; opacity: 1.0; border-radius: 50%;"></div>
                        <div class="legend-label"> Schools</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #000000; width: 16px; height: 16px; opacity: 1.0; border-radius: 50%;"></div>
                        <div class="legend-label"> Day Care Centers</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FBDBD9; width: 20px; height: 20px; opacity: 1.0;"></div>
                        <div class="legend-label">Park Lots</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FBDBD9; width: 20px; height: 20px; opacity: 0.3;"></div>
                        <div class="legend-label">Residential Areas</div>
                    </div>
                </div>
            </section>
            
            <section class="step" id="step-4" data-step="4">
                <div class="narrative">
                    <h2>Freight Focus: Industrial Corridors</h2>
                    <p><strong>Problem:</strong> Industrial corridors (<strong>Freight Routes</strong>) create disproportionate exposure in nearby residential areas, contributing to the asthma burden.</p>
                    <p><strong>Description:</strong> Isolates the <strong>Freight Routes</strong> that run through residential areas, emphasizing the industrial infrastructure that impacts community air quality.</p>
                </div>
                <div class="legend" id="legend-5">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 40px; height: 3px; margin-top: 8px; opacity: 1.0;"></div>
                        <div class="legend-label">Freight Routes</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 20px; height: 20px; opacity: 1.0;"></div>
                        <div class="legend-label">Freight Zones</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(to right, #f0f0f0, #d0d0d0, #909090, #505050, #000000); width: 60px; height: 20px; opacity: 0.7;"></div>
                        <div class="legend-label">↑ Asthma Index</div>
                    </div>
                </div>
            </section>
            
            <section class="step" id="step-5" data-step="5">
                <div class="narrative">
                    <h2>Policy: Targeting Green Spaces</h2>
                    <p><strong>Problem:</strong> Freight and idling zones often overlap with areas lacking sufficient green infrastructure (<strong>Park Lots</strong>), leading to poor air quality filtration in the most affected neighborhoods.</p>
                    <p><strong>Description:</strong> Isolates <strong>Park Lots</strong> to show the dual burden: high pollution sources combined with a lack of natural cooling and filtration amenities.</p>
                </div>
                <div class="legend" id="legend-6">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 40px; height: 3px; margin-top: 8px; opacity: 1.0;"></div>
                        <div class="legend-label">Freight Routes</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 20px; height: 20px; opacity: 1.0;"></div>
                        <div class="legend-label">Freight Zones</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #8B0000 0%, #CD5C5C 25%, #8B0000 50%, #CD5C5C 75%, #8B0000 100%); width: 20px; height: 20px; opacity: 0.8;"></div>
                        <div class="legend-label">Asthma Hex</div>
                    </div>
                </div>
            </section>
            
            <section class="step" id="step-6" data-step="6">
                <div class="narrative">
                    <h2>Conclusion: Data-Driven Regulation</h2>
                    <p><strong>Conclusion:</strong> The data confirms the need for a more targeted approach to enforce idling laws and protect vulnerable populations in these specific hotspots.</p>
                    <p><strong>Description:</strong> Serves as a call to action, concluding that the visual evidence necessitates data-driven regulatory change.</p>
                </div>
            </section>
            
            <section class="step" id="scroll-7-edestination-step" data-step="7">
                <div class="narrative">
                    <div class="narrative-box">
                        <h3 class="box-title" style="color: #FFFF00;">E-Designation: Zones of Regulatory Risk and Electrification Priority</h3>
                        
                        <hr style="border-top: 1px solid #333;">

                        <p>
                            <strong>Regulatory Spillover:</strong> This analysis uses E-designation zones—areas legally flagged by the city for potential environmental hazards like contamination, air pollution, and noise exposure—as a baseline for systemic risk. 
                        </p>

                        <p>
                            <strong>Targeted Mitigation:</strong> These zones are prioritized for **Electric Vehicle (EV) infrastructure investment**. By mapping the overlap between E-designation risk, high-traffic freight lines, and vulnerable facilities, we identify critical sites where vehicle electrification can achieve the greatest dual impact: reducing mobile source air pollution and mitigating chronic noise exposure.
                        </p>

                        <p>
                            The result is a strategy that focuses resources where the **regulatory failure** and the **public health need** are greatest, moving the community toward environmental justice.
                        </p>
                        
                        <div class="legend-callout">
                            <p style="margin-top: 10px;">
                                <span style="color: #FFFF00; font-weight: bold;">Yellow Dashed Lines:</span> E-Designation Boundaries (Regulatory Zones)
                            </p>
                        </div>
                    </div>
                </div>
                <div class="legend" id="legend-8">
                    <h4>EV Infrastructure Planning Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #808080; width: 20px; height: 20px; opacity: 0.5;"></div>
                        <div class="legend-label">Traffic Hotspots (Grey)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #DC143C; width: 20px; height: 20px; opacity: 0.5;"></div>
                        <div class="legend-label">Junction Hotspots</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #000000; width: 40px; height: 4px; margin-top: 8px; opacity: 1.0;"></div>
                        <div class="legend-label">Freight Routes (Black)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFFF00; width: 40px; height: 3px; margin-top: 8px; opacity: 1.0;"></div>
                        <div class="legend-label">E-Designation Areas</div>
                    </div>
                        <div class="legend-color" style="background-color: #00FF00; border: 1px solid #fff; width: 20px; height: 20px; opacity: 0.8;"></div>
                        <div class="legend-label">Vulnerable Facilities</div>
                    </div>
                    <div class="legend-item">
                </div>
            </section>

            <section class="step" id="scroll-8-imp-density-step" data-step="8">
                <div class="narrative">
                    <div class="narrative-box">
                        <h3 class="box-title" style="color: #B8D4E8;">Impervious Surface Density Analysis</h3>
                        
                        <hr style="border-top: 1px solid #333;">

                        <p>
                            <strong>Surface Analysis:</strong> This visualization reveals the extent of impervious surfaces across the area, highlighting areas with high concentrations of concrete, asphalt, and other non-permeable materials that contribute to urban heat island effects and stormwater runoff issues.
                        </p>

                        <p>
                            <strong>Planning Implications:</strong> This analysis identifies priority areas for green infrastructure investment, including tree planting, permeable surfaces, and cooling strategies to mitigate urban heat island effects.
                        </p>
                        
                        <div class="legend-callout">
                            <p style="margin-top: 10px;">
                                <span style="color: #FF6B35; font-weight: bold;">Color Gradient:</span> Light Blue (Low) → Blue-Grey (Medium) → Dark Grey (High Density)
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="legend" id="legend-9">
                    <h4>Impervious Surface Density Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #B8D4E8; width: 20px; height: 20px; opacity: 0.9;"></div>
                        <div class="legend-label">Low Density (0-25%)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #7FA5C7; width: 20px; height: 20px; opacity: 0.9;"></div>
                        <div class="legend-label">Low-Medium Density (25-50%)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4A5F7A; width: 20px; height: 20px; opacity: 0.9;"></div>
                        <div class="legend-label">Medium Density (50-75%)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2C3E50; width: 20px; height: 20px; opacity: 0.9;"></div>
                        <div class="legend-label">High Density (75-100%)</div>
                        <div class="legend-color" style="background-color: #1A252F; width: 20px; height: 20px; opacity: 0.9;"></div>
                        <div class="legend-label">Very High Density (>100%)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFFFFF; width: 20px; height: 20px; border: 2px solid #FFFFFF; opacity: 0.8;"></div>
                        <div class="legend-label">Parks (Green Infrastructure)</div>
                    </div>
                    <div class="legend-note">Focus: Areas requiring green infrastructure intervention</div>
                </div>
            </section>

            <section class="step" id="scroll-9-new-analysis-step" data-step="9">
                <div class="narrative">
                    <h2>Environmental Impact Assessment</h2>
                    <p><strong>Analysis:</strong> Comprehensive evaluation of environmental factors affecting urban sustainability.</p>
                    <p><strong>Description:</strong> This assessment examines multiple environmental indicators to identify areas requiring intervention and sustainable development strategies.</p>
                </div>
                <div class="legend" id="legend-10">
                    <h4>Environmental Impact Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2E8B57;"></div>
                        <div class="legend-label">Low Impact Areas</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FFD700;"></div>
                        <div class="legend-label">Moderate Impact Areas</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #DC143C;"></div>
                        <div class="legend-label">High Impact Areas</div>
                    </div>
                </div>
            </section>

            <section class="step" id="scroll-10-sustainability-step" data-step="10">
                <div class="narrative">
                    <h2>Sustainability Solutions Planning</h2>
                    <p><strong>Solution:</strong> Strategic planning for sustainable urban development and green infrastructure implementation.</p>
                    <p><strong>Description:</strong> This section outlines comprehensive sustainability strategies to address environmental challenges and promote resilient communities.</p>
                </div>
                <div class="legend" id="legend-11">
                    <h4>Sustainability Solutions Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #228B22;"></div>
                        <div class="legend-label">Green Infrastructure</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4682B4;"></div>
                        <div class="legend-label">Water Management</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #FF8C00;"></div>
                        <div class="legend-label">Energy Solutions</div>
                    </div>
                </div>
            </section>

            <section class="step" id="scroll-11-cvi-3d-step" data-step="11">
                <div class="narrative">
                    <h2>Climate Vulnerability: 3D Visualization</h2>
                    <p><strong>Innovation:</strong> Introducing 3D extrusion visualization of the Climate Vulnerability Index, where building heights represent vulnerability levels.</p>
                    <p><strong>Description:</strong> This 3D representation uses extrusion height and color intensity to show areas with highest climate vulnerability, creating a powerful visual hierarchy of risk across the city.</p>
                </div>
                <div class="legend" id="legend-12">
                    <h4>3D Extrusion Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(to bottom, #8B0000, #E10600); height: 20px; width: 20px;"></div>
                        <div class="legend-label">Vulnerability Level</div>
                    </div>
                    <div class="legend-scale">
                        <div class="legend-scale-label">Low</div>
                        <div class="legend-scale-bar" style="background: linear-gradient(to right, #8B0000, #E10600);"></div>
                        <div class="legend-scale-label">High</div>
                    <div class="legend-note">Height = Vulnerability Score</div>
                </div>
            </section>

            <section class="step" id="scroll-12-intervention-step" data-step="12">
                <div class="narrative">
                    <h2>Intervention: Flat 2D Introduction</h2>
                    <p><strong>Description:</strong> This 2D perspective introduces the intervention zones alongside the CVI problem areas, providing a clear view of where green infrastructure solutions are proposed.</p>
                    <p><strong>Analysis:</strong> The intervention zones (prominent yellow areas) are overlaid on the CVI vulnerability data (red areas) to show targeted solutions for the most at-risk locations.</p>
                </div>
                <div class="legend" id="legend-13">
                    <h4>Intervention Planning Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B; height: 20px; width: 20px; opacity: 1.0;"></div>
                        <div class="legend-label">Intervention Zones (Primary)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(to right, #8B0000, #E10600); height: 20px; width: 20px; opacity: 0.3;"></div>
                        <div class="legend-label">CVI Problem Areas</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e10600; width: 40px; height: 2px; margin-top: 8px; opacity: 0.2;"></div>
                        <div class="legend-label">Freight Routes (Background)</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffffff; border: 1px solid #ccc; width: 16px; height: 16px; opacity: 0.4;"></div>
                        <div class="legend-label">Vulnerable Facilities</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FBDBD9; width: 20px; height: 20px; opacity: 0.3;"></div>
                        <div class="legend-label">Park Areas</div>
                    </div>
                </div>
            </section>

            <section class="step" id="scroll-13-resilience-3d-step" data-step="13">
                <div class="narrative">
                    <h2>Resilience Solutions: 3D Intervention View</h2>
                    <p><strong>Description:</strong> This 3D perspective combines the intervention zones with the underlying vulnerability data, providing a comprehensive view of where green infrastructure can have the greatest impact.</p>
                </div>
                <div class="legend" id="legend-14">
                    <h4>3D Resilience Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B; height: 20px; width: 20px; opacity: 0.8;"></div>
                        <div class="legend-label">Intervention Zones</div>
                    </div>
                </div>
            </section>

            <section class="step" id="scroll-14-resilience-step" data-step="14">
                <div class="narrative">
                    <h2>Resilience Solutions: Canopy Gain Areas</h2>
                    <p><strong>Solution:</strong> Final implementation of green infrastructure canopy gain areas for climate resilience.</p>
                </div>
                <div class="legend" id="legend-15">
                    <h4>Resilience Solutions Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff9f9f; height: 20px; width: 20px; opacity: 0.5;"></div>
                        <div class="legend-label">Canopy Gain Areas</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #a5a5a5;; height: 20px; width: 20px;"></div>
                        <div class="legend-label">Existing Parks</div>
                    </div>
                    <div class="legend-note">Green areas represent priority zones for tree canopy expansion</div>
                </div>
            </section>

            <section class="step" id="scroll-15-secondary-intervention-step" data-step="15">
                <div class="narrative">
                    <h2>Secondary Intervention: Bivariate Analysis</h2>
                    <p><strong>Analysis:</strong> Two-dimensional analysis combining asthma rates and canopy coverage for residential areas.</p>
                    <p><strong>Description:</strong> This bivariate visualization identifies priority intervention areas by mapping the relationship between health indicators (asthma) and environmental factors (canopy coverage).</p>
                </div>
                <div class="legend" id="legend-16">
                    <h4>Bivariate Analysis Legend</h4>
                    <div class="legend-subtitle" style="font-size: 0.9em; margin-bottom: 12px; color: #ccc;">
                        Hue-Lightness Encoding: Canopy Coverage × Asthma Rates
                    </div>
                    
                    <div class="legend-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                        <!-- High Asthma Row -->
                        <div class="legend-item" style="background: hsl(0, 0%, 25%); padding: 8px; border-radius: 4px; text-align: center; color: white; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">High Asthma</div>
                            <div>Low Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(90, 30%, 35%); padding: 8px; border-radius: 4px; text-align: center; color: white; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">High Asthma</div>
                            <div>Mid Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(120, 45%, 30%); padding: 8px; border-radius: 4px; text-align: center; color: white; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">High Asthma</div>
                            <div>High Canopy</div>
                        </div>
                        
                        <!-- Medium Asthma Row -->
                        <div class="legend-item" style="background: hsl(0, 0%, 50%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Med Asthma</div>
                            <div>Low Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(90, 35%, 55%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Med Asthma</div>
                            <div>Mid Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(120, 45%, 55%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Med Asthma</div>
                            <div>High Canopy</div>
                        </div>
                        
                        <!-- Low Asthma Row -->
                        <div class="legend-item" style="background: hsl(0, 0%, 75%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Low Asthma</div>
                            <div>Low Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(90, 30%, 80%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Low Asthma</div>
                            <div>Mid Canopy</div>
                        </div>
                        <div class="legend-item" style="background: hsl(120, 35%, 80%); padding: 8px; border-radius: 4px; text-align: center; color: #333; font-size: 11px;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Low Asthma</div>
                            <div>High Canopy</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #ccc; margin-bottom: 4px;">Canopy Coverage:</div>
                        <div style="height: 20px; border-radius: 10px; background: linear-gradient(to right, hsl(0, 0%, 50%), hsl(60, 30%, 50%), hsl(120, 45%, 45%)); margin-bottom: 2px;"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #ccc;">
                            <span>Low (Gray)</span>
                            <span>High (Green)</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #ccc; margin-bottom: 4px;">Asthma Rates:</div>
                        <div style="height: 20px; border-radius: 10px; background: linear-gradient(to right, hsl(120, 40%, 30%), hsl(120, 40%, 55%), hsl(120, 35%, 85%)); margin-bottom: 2px;"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #ccc;">
                            <span>High (Dark)</span>
                            <span>Low (Light)</span>
                        </div>
                    </div>
                    
                    <div class="legend-note" style="background: rgba(255, 255, 255, 0.1); border-left: 4px solid #ccc; padding: 8px; margin-top: 12px; border-radius: 4px; font-size: 12px; color: #ccc;">
                        <strong>⚠️ Priority Intervention Areas:</strong> Dark gray cells (high asthma, low canopy) indicate the highest priority for secondary interventions in residential communities.
                    </div>
                </div>
            </section>

            <section class="step" id="scroll-16-trivariate-solutions" data-step="16">
                <div class="step-content" style="display: flex; gap: 2rem; align-items: flex-start;">
                    <div class="narrative" style="flex: 0 0 400px;">
                        <h2>Secondary Intervention: Residential Trivariate Analysis</h2>
                        <p><strong>Analysis:</strong> Advanced three-dimensional analysis incorporating asthma rates, canopy coverage, and overall vulnerability (CVI).</p>
                        <p><strong>Description:</strong> This trivariate visualization provides comprehensive insight by combining health indicators (asthma), environmental factors (canopy), and social vulnerability (CVI) through color intensity and opacity variations.</p>
                    </div>
                </div>
                <div class="legend" id="legend-17">
                </div>
            </section>

            <section class="step" id="scroll-17-city-type-step" data-step="17">
                <div class="narrative">
                    <h2>City Type Analysis</h2>
                    <div class="narrative-box">
                        <h3 class="box-title">Core Data Layer: Socio-Environmental Metrics</h3>
                        <hr>
                        <p>This foundational layer summarizes diverse environmental and social metrics into geographical tracts, serving as the basis for all vulnerability and intervention analyses.</p>

                        <h4>Key Metrics Included:</h4>
                        <ul>
                            <li>
                                <strong>City Type:</strong> Categorical field used for primary map rendering (e.g., Urban Core, Suburban, Planning Zone).
                            </li>
                            <li>
                                <strong>Imperviousness:</strong> Measures of pavement and building density, essential for assessing stormwater runoff and heat risk (e.g., <code>Imp_Density</code>).
                            </li>
                            <li>
                                <strong>Heat Risk:</strong> Quantifies localized heat amplification and extreme heat exposure (e.g., <code>HeatAmp_mean</code>).
                            </li>
                            <li>
                                <strong>Vulnerability:</strong> Critical fields like <code>Asthma_mean</code> and the Composite Vulnerability Index (<code>CVI</code>), used to identify areas of greatest public health disparity.
                            </li>
                        </ul>
                    </div>
                    <p><strong>Analysis:</strong> Classification of urban areas based on their environmental and social characteristics.</p>
                    <p><strong>Description:</strong> This visualization categorizes different city types to understand urban patterns and inform targeted interventions.</p>
                    <div class="legend" id="legend-18">
                        <h4>City Types:</h4>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #808080; border: 1px solid #666; width: 24px; height: 24px;"></span>
                            <span class="legend-label">Grey City: Dense urban development</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #228B22; border: 1px solid #1a6b1a; width: 24px; height: 24px;"></span>
                            <span class="legend-label">Green City: Areas with abundant vegetation</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #8B4513; border: 1px solid #6b3410; width: 24px; height: 24px;"></span>
                            <span class="legend-label">Feral City: Wild or untamed urban spaces</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #4169E1; border: 1px solid #3455c1; width: 24px; height: 24px;"></span>
                            <span class="legend-label">Human City: People-centered urban environments</span>
                        </div>
                        <h4 style="margin-top: 15px;">Residential Areas:</h4>
                        <div class="legend-item">
                            <span class="legend-color" id="residential-legend-pattern" style="width: 24px; height: 24px;"></span>
                            <span class="legend-label">Residential: Diagonal pattern overlay</span>
                        </div>
                        
                        <h4 style="margin-top: 20px;">Residential Area Distribution</h4>
                        <div style="position: relative; height: 300px; margin: 15px 0;">
                            <canvas id="residentialPieChart"></canvas>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; background: #4a5568; border-radius: 3px;"></div>
                                <span style="font-size: 12px; color: #ccc;">Residential in Grey City</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div id="pie-legend-pattern" style="width: 16px; height: 16px; border-radius: 3px; border: 1px solid #E47675;"></div>
                                <span style="font-size: 12px; color: #ccc;">Residential Outside Grey City</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="city-type-chart"></div>
            </section>

        </div>
    </div>

    <!-- Load Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <!-- Load Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <!-- Load Scrollama -->
    <script src="lib/scrollama.min.js"></script>
    <!-- Load our script last -->
    <script src="script.js"></script> 
    <!-- Load Trivariate Heatmap -->
    <script src="trivariate-heatmap-vanilla.js"></script>
    
    <!-- Initialize Residential Pie Chart -->
    <script>
        // Wait for DOM to be loaded and Chart.js to be available
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Chart is available
            if (typeof Chart === 'undefined') {
                console.log('Chart.js not loaded yet, will retry...');
                setTimeout(initResidentialChart, 1000);
                return;
            }
            initResidentialChart();
        });
        
        function createDiagonalPattern(color, includeBackground = true) {
            // Create a canvas element
            const canvas = document.createElement('canvas');
            canvas.width = 20;
            canvas.height = 20;
            const ctx = canvas.getContext('2d');
            
            // Fill background with the color if requested
            if (includeBackground) {
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, 20, 20);
            }
            
            // Create white diagonal lines
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.globalAlpha = includeBackground ? 0.6 : 0.8;
            
            // Draw multiple diagonal lines
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(20, 0);
            ctx.moveTo(5, 20);
            ctx.lineTo(20, 5);
            ctx.moveTo(10, 20);
            ctx.lineTo(20, 10);
            ctx.moveTo(15, 20);
            ctx.lineTo(20, 15);
            ctx.moveTo(0, 15);
            ctx.lineTo(15, 0);
            ctx.moveTo(0, 10);
            ctx.lineTo(10, 0);
            ctx.moveTo(0, 5);
            ctx.lineTo(5, 0);
            ctx.stroke();
            
            return canvas;
        }
        
        function initResidentialChart() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js still not available, will retry...');
                setTimeout(initResidentialChart, 1000);
                return;
            }
            
            // Apply diagonal pattern to legend icon (transparent background for scroll 16)
            const legendPattern = document.getElementById('residential-legend-pattern');
            if (legendPattern) {
                const patternCanvas = createDiagonalPattern('#FBDBD9', false); // No background
                legendPattern.style.background = `url(${patternCanvas.toDataURL()})`;
                legendPattern.style.backgroundSize = '20px 20px';
                legendPattern.style.border = '1px solid #E47675';
            }
            
            // Apply diagonal pattern to pie chart legend (with background)
            const pieLegendPattern = document.getElementById('pie-legend-pattern');
            if (pieLegendPattern) {
                const piePatternCanvas = createDiagonalPattern('#FBDBD9', true); // With background
                pieLegendPattern.style.background = `url(${piePatternCanvas.toDataURL()})`;
                pieLegendPattern.style.backgroundSize = '16px 16px';
            }
            
            const ctx = document.getElementById('residentialPieChart');
            if (!ctx) {
                console.log('residentialPieChart canvas not found');
                return;
            }
            
            // Create diagonal pattern for Chart.js (with background)
            const patternCanvas = createDiagonalPattern('#FBDBD9', true); // With background
            const chartCtx = ctx.getContext('2d');
            const pattern = chartCtx.createPattern(patternCanvas, 'repeat');
            
            const data = {
                labels: [
                    'Residential in Grey City (40.87%)',
                    'Residential Outside Grey City (59.13%)'
                ],
                datasets: [{
                    data: [23565633.09, 34097186.08],
                    backgroundColor: [
                        '#4a5568',  // Grey for Grey City
                        pattern // Diagonal pattern for Outside
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverOffset: 15
                }]
            };
            
            const config = {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = context.dataset.data[context.dataIndex] / 57662819.17 * 100;
                                    return [
                                        `Area: ${value.toLocaleString()} sq units`,
                                        `Percentage: ${percentage.toFixed(2)}%` 
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            new Chart(ctx, config);
            console.log('Residential pie chart initialized successfully');
        }
    </script> 
</body>
</html>